/**
 * @file Firebase Security Rules for the Emirates Law Hub application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user can only access and modify their own data,
 * stored under their unique user ID in the `/users/{userId}` collection.
 *
 * Data Structure:
 * All user data is stored under the `/users/{userId}` collection.  The `userId` path segment must
 * match the authenticated user's UID.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to protect user privacy.
 * - All writes require a verified user identity.
 * - Data validation is relaxed in this prototyping phase, focusing on authorization and relational integrity.
 *
 * Denormalization for Authorization:
 * The `id` field within each user document must match the `userId` path segment. This redundancy, enforced
 * on creation and immutability, ensures that the correct ownership link is always present and cannot be
 * changed after creation. This allows for simple and performant security rules without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles.  Only the authenticated user can read or write their own profile data.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' creates a profile with /users/user_abc and data { id: 'user_abc', ... }.
     * @allow (get, update, delete) - User with UID 'user_abc' reads/updates/deletes their profile at /users/user_abc.
     * @deny (create) - User with UID 'user_abc' attempts to create a profile at /users/user_xyz.
     * @deny (get, update, delete) - User with UID 'user_xyz' attempts to read/update/delete the profile at /users/user_abc.
     * @principle Enforces document ownership for all operations. Validates relational integrity.
     */
    match /users/{userId} {
      //isSignedin checks to see if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }
      //isOwner checks to see if the user id matches request.auth.uid
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      //isExistingOwner checks to see if the user is owner and if resource exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      //create rule to see if new user is signed in and if user owns the id
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      //get rule to see if user is signed in and the owner
      allow get: if isSignedIn() && isOwner(userId);
      //list rule that denies listing for privacy
      allow list: if false;
      //update rule to see if the user is signed in, if the resource exists, if the user is the owner and if the user id in request is the same as the existing resource.id (for immutability)
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      //delete rule to see if the user is signed in and if the user is the owner and if the resource exists.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}